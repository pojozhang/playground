# 索引

## 索引选择

通常我们为会一个集合建立多种索引以满足各种查询场景，Mongo通过竞赛的方式选择使用哪一个索引进行查询。
当一个查询开始时，Mongo会根据查询条件筛选出一组候选索引，并使用这些候选索引并行查询，然后选择一个最快返回的作为同类型查询的索引。

## 查询计划

可以通过以下语句查看查询计划：`db.col.find({}).explain('executionStats')`

- nReturned：本次查询返回的文档数量。
- executionTimeMillis：本次查询的耗时。
- totalDocsExamined：
- totalKeyExamined：查找过的索引项的数量，如果是全表扫描，这个数字就是扫描过的文档数量。
- stage：如果使用索引执行查询则显示`IXSCAN`，否则显示`COLLSCAN`。
- indexBounds：描述了索引的扫描范围。

## 复合索引

假设有一个users集合，每个文档主要有两个字段：用户名`username`和年龄`age`。

现在对这两个字段建立一个复合索引`{"age": 1, "username": 1}`，那么这个索引的内容大致长这样：

```
[0, "user100020"] -> <记录标识符>
[0, "user100388"] -> <记录标识符>
[1, "user100113"] -> <记录标识符>
[1, "user100280"] -> <记录标识符>
[2, "user100191"] -> <记录标识符>
[2, "user100197"] -> <记录标识符>
```

每个索引项都包含年龄和用户名，指向一个记录标识符，并且先按年龄升序排序，年龄相同的按用户名升序排序。

- 等值查询

```javascript
db.users.find({"age": 2}).sort({"username": -1})
```

这种情况在查询时只要先根据`age`的值定位到索引项，然后按顺序遍历索引项即可，因为索引已经是按照`username`排好序的，所以Mongo不需要对查询结果进行额外的排序。

- 范围查询

```javascript
db.users.find({"age": {"$gte": 1, "$lte":10}})
```

以上语句会用到索引的`age`部分，Mongo通过遍历索引即可得到查询结果。

```javascript
db.users.find({"age": {"$gte": 1, "$lte":10}}).sort({"username": -1})
```

如果我们希望查询结果根据用户名进行排序，那么Mongo通过`age`字段过滤出查询结果后还需要在内存中对结果进行排序。如果数据量较大，那么会影响查询速度；如果数据量超过32MB，Mongo会直接报错，解决方法是对查询加上limit限制。在实践中通常把需要进行排序的键放在索引的第一位以减少Mongo排序的压力，在此例中可以建立`{"username": 1, "age": 1}`索引。

大多数情况下设计复合索引的最佳实践：

- 等值过滤的键应该在最前面
- 排序的键应该在多指字段前面
- 多值过滤的键应该在最后面

## 索引的方向

当我们需要为多个字段进行排序时，还需要关注创建索引时指定的键的顺序是否和查询时所需的一致。

例如在users集合上建立了索引`{"age": 1, "username": 1}`，但查询时按`{"age": 1, "username": -1}`排序，由于查询中`username`按降序排序，因为无法用到原来的索引，我们必须重新建立一个新的索引`{"age": 1, "username": -1}`。
如果索引建立的顺序和查询时的顺序完全相反，那么Mongo也可以处理，例如在以`{"age": 1, "username": -1}`对数据进行排序时，`{"age": -1, "username": 1}`这样的索引也能满足需求。

## 运算符

- `$ne`
`{"age": {"$ne": 2}}`会查找所有年龄小于2和大于2的索引项，如果索引中值为2的项较多，那么查询效率较高。

- `$not`
有时候可以把查询条件进行反转从而能够利用索引，例如`{"age": {"$not": {"$lt: 2}}}`转换为`{"age": {"$gte: 2}}`，大部分情况下会使用全表扫描。

- `$nin`
只能全表扫描。

- `$or`
一般情况下一个查询语句只能使用一个索引，但是`$or`运算符除外，每个`$or`字句都可以使用一个索引，实际上Mongo会查询多次，最后把结果合并。

## 数组

对数组建立索引实际是对数组中的每一个元素建立一个索引项，如果一个文档的一个数组包含20个元素，那么就会对应20个索引项。索引项只允许一个字段来自数组，这是为了避免索引项数量过多，例如假设有字段`x`、`y`且都是数组，如果一个文档的`x`数组有3个元素，`y`数组有4个元素，那么该文档都有3*4一共12个索引项。
